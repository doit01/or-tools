在 Timefold 中，局部搜索（Local Search, LS） 是求解过程的第二阶段，也是产生“高质量、高效率”方案的关键阶段。

如果说 构建启发式（CH） 是在几秒钟内快速拼凑出一个“能用但简陋”的初稿，那么 局部搜索（LS） 就是通过不断的小范围微调，把初稿打磨成“接近完美”的最优解。

以下是针对 CDMO 反应釜排产场景的详细拆解：

1. 局部搜索的核心工作流程

局部搜索像是一个不断尝试的计划员：

从 CH 的结果开始（此时所有任务都已分配了反应釜和时间）。

尝试一个“移动（Move）”：比如把“批次 A”从“反应釜 1”挪到“反应釜 2”。

重新评估分数：看看这个改动是让总时间变短了（得分提高），还是违反了清洗规则（得分下降）。

决定是否接受：根据具体的算法逻辑（如禁忌搜索）决定是留下这个改动，还是退回到上一步。

循环往复，直到达到你设置的时间上限。

2. 局部搜索要解决的核心问题：局部最优（Local Optima）

这是所有排产算法最大的敌人。

什么是局部最优？：就像你在爬山，爬到一个小山丘顶时，发现往前后左右走都是下坡。如果你只敢往高处走，你就永远发现不了远处更高的珠穆朗玛峰。

LS 的任务：通过一些“聪明”的策略（如允许暂时接受较差的解），跳出当前的小山丘，去寻找更高的大山。

3. 三种最常用的局部搜索算法

在文档中，你会看到几种算法，在 CDMO 场景中推荐顺序如下：

A. 禁忌搜索（Tabu Search）—— 推荐首选

逻辑：它会维护一个“禁忌名单（Tabu List）”，记录最近几次尝试过的动作。

CDMO 场景：如果你刚刚把“批次 A”从釜 1 移走，禁忌搜索在接下来的一段时间内会禁止你再把它移回釜 1。

优点：非常有效地防止“原地打转”，强制 Solver 去探索以前没试过的方案。

B. 模拟退火（Simulated Annealing）

逻辑：借鉴了金属冶炼。开始时温度高，允许乱跳（接受很差的解）；随着时间推移温度降低，变得保守，只接受更好的解。

优点：适合在超大范围内寻找可能性。

C. 迟滞接受（Late Acceptance）

逻辑：不跟上一步比，而是跟几百步之前的分数比。

优点：配置简单，性能非常稳定，适合绝大多数通用的排产问题。

4. 关键概念：接受准则（Acceptance Criteria）

局部搜索决定“是否接受一个 Move”的逻辑非常重要。

Hill Climbing（爬山算法）：只要变好就接受。

问题：极易死在第一个小山丘上。

Strategic Stepping（策略步进）：即使变差了，如果有潜力跳出局部最优，也可能接受。这就是 Tabu Search 和 Simulated Annealing 的强大之处。

5. 针对 CDMO 反应釜排产的配置建议

在你的 solverConfig.xml 中，典型的配置看起来像这样：

code
Xml
download
content_copy
expand_less
<solver>
  ...
  <!-- 第一阶段：快排初稿 -->
  <constructionHeuristic>
    <constructionHeuristicType>FIRST_FIT_DECREASING</constructionHeuristicType>
  </constructionHeuristic>

  <!-- 第二阶段：精雕细琢 -->
  <localSearch>
    <localSearchType>TABU_SEARCH</localSearchType>
    <!-- 禁忌名单大小：通常设置在 7 左右 -->
    <acceptor>
      <entityTabuSize>7</entityTabuSize>
    </acceptor>
    <forager>
      <!-- 每一步观察多少个可能的移动 -->
      <acceptedCountLimit>1000</acceptedCountLimit>
    </forager>
  </localSearch>
</solver>
6. 为什么局部搜索对你至关重要？

在 CDMO 生产中，有两个指标最难平衡：

切换成本（清洗时间）：这取决于反应釜的任务顺序。

交货期（Deadline）：这取决于任务的分配。

局部搜索的威力在于：
它会先尝试通过移动任务来满足所有的 Hard Constraints（硬约束，如：材质兼容、体积匹配）。一旦合法了，它就开始在 Soft Constraints 上发力。它会不断尝试交换两个相邻任务的顺序，看看能不能省掉一次深度清洗（CIP）；或者尝试把一个长任务移到另一台空闲设备上，以缩短整个工期。

总结

CH（第一阶段） 负责给你一个“及格”的方案。

LS（第二阶段） 负责把“及格”提升到“优秀”甚至“卓越”。

在 CDMO 场景下，请直接使用 Tabu Search，它在处理这种复杂的顺序依赖和设备分配问题上，表现最为稳健。
